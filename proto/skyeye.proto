syntax = "proto3";

package skyeye;
option go_package = "./;pb";

message IP {
  bytes slice = 1;
}

message PingJob {
  uint64 job_id = 1;
  uint32 interval_ms = 2;
  uint32 timeout_ms = 3;  // per packet timeout
  uint32 count = 4;       // packets per IP per interval
  repeated IP destinations = 5;
  oneof source {
    string port = 6;
    IP ip = 7;
  }
}

message PingRoundResult {
  uint64 job_id = 1;
  uint64 round_id = 2;
  IP destination = 3;
  uint32 sent = 4;
  uint32 recv = 5;
  uint32 timeout = 6;
  uint32 send_error = 7;
  double loss_rate = 8;
  int64 min_rtt_nano = 9;
  int64 avg_rtt_nano = 10;
  int64 max_rtt_nano = 11;
}

message CancelPingJob {
  uint64 job_id = 1;
}

message ControllerMessage {
  oneof payload {
    CancelPingJob cancel_ping_job = 1;
    PingJob ping_job = 2;
  }
}

message NetworkInterface {
  string name = 1;
  repeated string addrs = 2;
}

message Register {
  string agent_id = 1;
  string version = 2;
  uint64 capabilities = 3;
  string hostname = 4;
  repeated NetworkInterface network_interfaces = 5;
}

message Heartbeat {
  int64 timestampMill = 1;
}

message AgentMessage {
  oneof payload {
    Register register = 1;
    Heartbeat heartbeat = 2;
    PingRoundResult ping_round_result = 3;
  }
}

service ManagementService {
  rpc Stream(stream AgentMessage) returns (stream ControllerMessage);
}
